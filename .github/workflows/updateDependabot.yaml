name: update Dependabot

on:
  workflow_dispatch:
    inputs:
      port_payload:
        description: 'The payload from port'
        required: false

jobs:
  calculate_Dependabots:
    runs-on: ubuntu-latest

    steps:
      - name: Search for Dependabot alerts
        uses: port-labs/port-github-action@v1
        id: search
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: SEARCH
          blueprint: dependabotAlert
          query: |
            {
              "combinator": "and",
              "rules": [
                {
                  "blueprint": "repository",
                  "operator": "relatedTo",
                  "value": "${{ github.event.inputs.port_payload.context.entity }}"
                },
                {
                  "property": "severity",
                  "operator": "=",
                  "value": "low"
                }
              ]
            }
      - name: Debug search results
        run: echo "'${{ steps.search.outputs.entities }}'"

      - name: Calculate length of entities array
        id: entity-count
        run: echo "::set-output name=entity-counter::$(echo '${{ steps.search.outputs.entities }}' | jq '. | length')"

      - name: Parse JSON input
        id: parse
        run: echo "::set-output name=parsed::$(echo '${{ github.event.inputs.port_payload }}' | jq -r '.context.entity')"

      - name: Update port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: UPSERT
          identifier: ${{ steps.parse.outputs.parsed }}
          blueprint: repository
          properties: |
            {
              "lowDependabot": "${{ steps.entity-count.outputs.entity-counter }}"
            }